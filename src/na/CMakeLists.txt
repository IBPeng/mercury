cmake_minimum_required(VERSION 2.8)
project(NA C)

# Set unique var used in the autogenerated config file (symbol import/export)
if(BUILD_SHARED_LIBS)
  set(NA_BUILD_SHARED_LIBS 1)
  set(NA_LIBTYPE SHARED)
else(BUILD_SHARED_LIBS)
  set(NA_BUILD_SHARED_LIBS 0)
  set(NA_LIBTYPE STATIC)
endif(BUILD_SHARED_LIBS)

#------------------------------------------------------------------------------
# External dependencies
#------------------------------------------------------------------------------
# mercury_util
include_directories(${MERCURY_SOURCE_DIR}/src/util)

# BMI
option(NA_USE_BMI "Use BMI." OFF)
if(NA_USE_BMI)
  find_package(BMI REQUIRED)
  if(BMI_FOUND)
    set(NA_PLUGINS ${NA_PLUGINS} bmi)
    set(NA_HAS_BMI 1)
    include_directories(${BMI_INCLUDE_DIR})
    set(NA_EXT_LIB_DEPENDENCIES
      ${NA_EXT_LIB_DEPENDENCIES}
      ${BMI_LIBRARIES}
    )
    set(NA_EXT_INCLUDE_DEPENDENCIES
      ${NA_EXT_INCLUDE_DEPENDENCIES}
      ${BMI_INCLUDE_DIR}
    )
    include(CheckCSourceCompiles)
    check_c_source_compiles("#include <bmi.h>
      int main(int argc, char **argv) {
        BMI_set_info(0,BMI_ZOID_POST_TIMEOUT,0);
      }
     " HAVE_BMI_ZOID_TIMEOUT)
  else(BMI_FOUND)
    message(FATAL_ERROR "Could not find BMI.")
  endif(BMI_FOUND)
endif(NA_USE_BMI)

# MPI
option(NA_USE_MPI "Use MPI." OFF)
if(NA_USE_MPI)
  find_package(MPI)
  if(MPI_FOUND)
    option(NA_MPI_USE_STATIC_CONNECTION "Use static connection instead of dynamic." OFF)
    if(NA_MPI_USE_STATIC_CONNECTION)
      set(NA_MPI_HAS_STATIC_CONNECTION 1)
    endif(NA_MPI_USE_STATIC_CONNECTION)
    set(NA_HAS_MPI 1)
    set(NA_PLUGINS ${NA_PLUGINS} mpi)
    include_directories(${MPI_INCLUDE_PATH})
    set(NA_EXT_LIB_DEPENDENCIES
      ${NA_EXT_LIB_DEPENDENCIES}
      ${MPI_LIBRARIES}
    )
    set(NA_EXT_INCLUDE_DEPENDENCIES
      ${NA_EXT_INCLUDE_DEPENDENCIES}
      ${MPI_INCLUDE_PATH}
    )
  # we may want to add an option for MPI_VERSION >= 3
  else(MPI_FOUND)
    message(FATAL_ERROR "Could not find MPI.")
  endif(MPI_FOUND)
endif(NA_USE_MPI)


option(NA_USE_CLIENT_THREAD "Allow use of thread for making progress on client." ON)
if(NA_USE_CLIENT_THREAD)
  set(NA_HAS_CLIENT_THREAD 1)
endif(NA_USE_CLIENT_THREAD)

#------------------------------------------------------------------------------
# Configure module header files
#------------------------------------------------------------------------------
configure_file(
  ${CMAKE_CURRENT_SOURCE_DIR}/na_config.h.in
  ${CMAKE_CURRENT_BINARY_DIR}/na_config.h
)

#------------------------------------------------------------------------------
# Set sources
#------------------------------------------------------------------------------
include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_BINARY_DIR}
)

set(NA_SRCS
  ${CMAKE_CURRENT_SOURCE_DIR}/na.c
)

if(NA_USE_BMI)
  set(NA_SRCS
    ${NA_SRCS}
    ${CMAKE_CURRENT_SOURCE_DIR}/na_bmi.c
  )
endif(NA_USE_BMI)

if(NA_USE_MPI)
  set(NA_SRCS
    ${NA_SRCS}
    ${CMAKE_CURRENT_SOURCE_DIR}/na_mpi.c
  )
endif(NA_USE_MPI)

if(MERCURY_CREATE_SINGLE_LIB)
  set(NA_SRCS
    ${NA_SRCS}
    PARENT_SCOPE
  )
else(MERCURY_CREATE_SINGLE_LIB)
  #----------------------------------------------------------------------------
  # Libraries
  #----------------------------------------------------------------------------
  # NA
  add_library(na ${NA_SRCS})
  target_link_libraries(na ${NA_EXT_LIB_DEPENDENCIES} mercury_util)
  set_lib_options(na "na" ${NA_LIBTYPE})
  if(MERCURY_ENABLE_COVERAGE)
    set_coverage_flags(na)
  endif(MERCURY_ENABLE_COVERAGE)

  #---------------------------------------------------------------------------
  # Add Target(s) to CMake Install
  #---------------------------------------------------------------------------
  install(
    TARGETS
      na
    EXPORT
      ${MERCURY_EXPORTED_TARGETS}
    LIBRARY DESTINATION ${MERCURY_INSTALL_LIB_DIR}
    ARCHIVE DESTINATION ${MERCURY_INSTALL_LIB_DIR}
    RUNTIME DESTINATION ${MERCURY_INSTALL_BIN_DIR}
  )
endif(MERCURY_CREATE_SINGLE_LIB)

#-----------------------------------------------------------------------------
# Specify project header files to be installed
#-----------------------------------------------------------------------------
set(NA_HEADERS
  ${CMAKE_CURRENT_SOURCE_DIR}/na.h
  ${CMAKE_CURRENT_SOURCE_DIR}/na_error.h
  ${CMAKE_CURRENT_BINARY_DIR}/na_config.h
)

if(NA_USE_BMI)
  set(NA_HEADERS
    ${NA_HEADERS}
    ${CMAKE_CURRENT_SOURCE_DIR}/na_bmi.h
  )
endif(NA_USE_BMI)

if(NA_USE_MPI)
  set(NA_HEADERS
    ${NA_HEADERS}
    ${CMAKE_CURRENT_SOURCE_DIR}/na_mpi.h
  )
endif(NA_USE_MPI)

#-----------------------------------------------------------------------------
# Add file(s) to CMake Install
#-----------------------------------------------------------------------------
install(
  FILES
    ${NA_HEADERS}
  DESTINATION
    ${MERCURY_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

#------------------------------------------------------------------------------
# Set variables for parent scope
#------------------------------------------------------------------------------
set(NA_PLUGINS ${NA_PLUGINS} PARENT_SCOPE)
set(NA_EXT_INCLUDE_DEPENDENCIES ${NA_EXT_INCLUDE_DEPENDENCIES} PARENT_SCOPE)
set(NA_EXT_LIB_DEPENDENCIES ${NA_EXT_LIB_DEPENDENCIES} PARENT_SCOPE)
