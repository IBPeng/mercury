#------------------------------------------------------------------------------
# External dependencies
#------------------------------------------------------------------------------
# Threads
include(FindThreads)
set(MERCURY_UTIL_EXT_LIB_DEPENDENCIES
  ${MERCURY_UTIL_EXT_LIB_DEPENDENCIES}
  ${CMAKE_THREAD_LIBS_INIT}
)

# Rt
if(NOT WIN32)
  set(MERCURY_UTIL_EXT_LIB_DEPENDENCIES
    ${MERCURY_UTIL_EXT_LIB_DEPENDENCIES}
    rt
  )
endif()

#------------------------------------------------------------------------------
# Configure module header files
#------------------------------------------------------------------------------
# Set unique var used in the autogenerated config file (symbol import/export)
if(BUILD_SHARED_LIBS)
  set(HG_UTIL_BUILD_SHARED_LIBS 1)
  set(MERCURY_UTIL_LIBTYPE SHARED)
else()
  set(HG_UTIL_BUILD_SHARED_LIBS 0)
  set(MERCURY_UTIL_LIBTYPE STATIC)
endif()

configure_file(
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_util_config.h.in
  ${CMAKE_CURRENT_BINARY_DIR}/mercury_util_config.h
)

#------------------------------------------------------------------------------
# Set sources
#------------------------------------------------------------------------------
include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/..
  ${CMAKE_CURRENT_BINARY_DIR}
  )

set(MERCURY_UTIL_SRCS
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_hash_table.c
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_list.c
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_thread.c
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_thread_mutex.c
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_thread_condition.c
  ${CMAKE_CURRENT_SOURCE_DIR}/mercury_time.c
)

if(MERCURY_CREATE_SINGLE_LIB)
  set(MERCURY_UTIL_SRCS
    ${MERCURY_UTIL_SRCS}
    PARENT_SCOPE
  )
else()
  #----------------------------------------------------------------------------
  # Libraries
  #----------------------------------------------------------------------------
  # UTIL
  add_library(mercury_util ${MERCURY_UTIL_SRCS})
  target_link_libraries(mercury_util ${MERCURY_UTIL_EXT_LIB_DEPENDENCIES})
  set_lib_options(mercury_util "mercury_util" ${MERCURY_UTIL_LIBTYPE})
  if(MERCURY_ENABLE_COVERAGE)
    set_coverage_flags(mercury_util)
  endif()

  #---------------------------------------------------------------------------
  # Add Target(s) to CMake Install
  #---------------------------------------------------------------------------
  install(
    TARGETS
      mercury_util
    EXPORT
      ${MERCURY_EXPORTED_TARGETS}
    LIBRARY DESTINATION ${MERCURY_INSTALL_LIB_DIR}
    ARCHIVE DESTINATION ${MERCURY_INSTALL_LIB_DIR}
    RUNTIME DESTINATION ${MERCURY_INSTALL_BIN_DIR}
  )
endif()

#------------------------------------------------------------------------------
# Set variables for parent scope
#------------------------------------------------------------------------------
set(MERCURY_UTIL_EXT_LIB_DEPENDENCIES ${MERCURY_UTIL_EXT_LIB_DEPENDENCIES} PARENT_SCOPE)
